#!/bin/bash

CONFIG="$HOME/.config/mimi/mime.conf"

find_in_config() {
    [[ -r "$CONFIG" ]] || return
    line=$(grep -m 1 "^$1: " "$CONFIG")
    if [[ $line == "" ]]; then
        type=$(echo $1 | cut -d / -f 1)
        line=$(grep -m 1 "^$type/[*]: " "$CONFIG")
    fi
    echo $line | cut -d ' ' -f 2-
}

need_terminal() {
    grep -m 1 "^Terminal=true$" "$1"
}

find_cmd() {
    grep -m 1 "^Exec=" $1 | cut -d = -f 2 | cut -d ' ' -f 1
}

find_terminal() {
    find_app_by Categories TerminalEmulator
}

find_app_by() {
    grep "$1=.*$2;" -R /usr/share/applications/ | awk -F : '{ print length($2), $0 }' | sort -n | head -n 1 | cut -d ' ' -f2 | cut -d : -f 1
}

usage() {
    cat <<EOF

Usage: xdg-open [file|directory|protocol]

It opens a file according to the extension
To setup the extension, create $CONFIG

mimi :)
EOF
exit 1
}

arg="$@"

if [[ "$arg" =~ ^file://(.*) ]]; then
    # strip file://
    arg="${BASH_REMATCH[1]}"
fi

if [[ -e "$arg" ]]; then
    # file or dir
    mime=$(file -b --mime-type "$arg")
elif [[ "$arg" =~ ^([a-zA-Z]+): ]]; then
    # handle protocol
    protocol=${BASH_REMATCH[1]}
    if [[ $protocol == "http" || $protocol == "https" ]]; then
        mime="text/html"
    elif [[ $protocol == "magnet" ]]; then
        mime="application/x-bittorrent"
    else
        usage
    fi
else
    usage
fi

echo "$arg: $mime"
app=$(find_in_config $mime)
if [[ "$app" != "" ]]; then
    # has config and mime defined in config
    exec $app "$arg"
else
    # find our own
    desktop=$(find_app_by MimeType $mime)
    echo $desktop
    if [[ "$desktop" != "" ]]; then
        app=$(find_cmd $desktop)
        if [[ $(need_terminal $desktop) != "" && $(find_terminal) != "" ]]; then
            exec find_terminal -e $app "$arg"
        else
            exec $app "$arg"
        fi
    else
        usage
    fi
fi
